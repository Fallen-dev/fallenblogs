---
import Body from "$com/Body.astro";
import Posts from "$lib/components/Posts.svelte";
import TableOfContents from "$lib/components/TableOfContents.svelte";
import { formatDate } from "$lib/utils";
import { Image } from "astro:assets";
import { getEntry } from "astro:content";

const { slug } = Astro.params;

if (!slug) return;

const post = await getEntry("blogs", slug);
if (!post) return;

async function followUpPost() {
  if (!post || typeof post.data.followUp === "undefined") return false;

  const followUpPost = await getEntry("blogs", post.data.followUp.slug);

  return followUpPost.data.title;
}

const { Content, headings, remarkPluginFrontmatter } = await post.render();
type Data = { slug: string; depth: number; text: string };

const toc = [] as any;

headings?.forEach((item: Data) => {
  switch (item.depth) {
    case 1:
      toc.push(item);
      break;
    case 2:
      toc.push(item);
      break;
    case 3:
      toc.push([item]);
      break;
    case 4:
      toc.push([[item]]);
      break;
    case 5:
      toc.push([[[item]]]);
      break;
    case 6:
      toc.push([[[[item]]]]);
      break;
    default:
      break;
  }
});
---

<Body
  title={post.data.title}
  article
  publishedOn={post.data.publishedOn}
  image={post.data.image}
>
  <a href="/" class="contrast"><p>&larr; Back to post</p></a>

  <section>
    <hgroup id="post-title">
      <h1 class="title" style="opacity: 0;">{post.data.title}</h1>
      <p>
        Published on {formatDate(post.data.publishedOn)} &bull; {
          remarkPluginFrontmatter.minutesRead
        }
      </p>
    </hgroup>
  </section>

  <section>
    <figure id="hero">
      <Image
        src={post.data.image || "/images/placeholder.webp"}
        alt="Just an image"
        width={1000}
        height={600}
        format="webp"
        loading="eager"
      />
    </figure>
  </section>

  <div id="prose">
    <article id="toc">
      <h6>Table of contents</h6>
      <TableOfContents headings={toc} />
    </article>

    <figure id="md">
      <Content />
    </figure>
  </div>

  <section id="bottom-navigation">
    <a href="/" class="contrast">&larr; Back to post</a>

    {
      post.data.followUp && (
        <a
          href={`/post/${post.data.followUp.slug}`}
          role="button"
          class="contrast outline"
        >
          <strong>Follow up:</strong>&ThinSpace;
          {followUpPost()} &rarr;
        </a>
      )
    }
  </section>

  <Posts postId={post.id} postTags={post.data.tags} client:idle />
</Body>

<script>
  import { fadeIn } from "$lib/utils";

  fadeIn(".title");
</script>

<script>
  const headings = document.querySelectorAll(
    "#md > h1, #md > h2, #md > h3, #md > h4, #md > h5, #md > h6",
  );

  function headingsObserver(entries: IntersectionObserverEntry[]) {
    entries.forEach((entry) => {
      const link = document.querySelector(`a[href="#${entry.target.id}"]`);

      if (entry.isIntersecting) link?.classList.remove("contrast");
      else link?.classList.add("contrast");
    });
  }

  const observer = new IntersectionObserver(headingsObserver);

  headings.forEach((heading) => observer.observe(heading));
</script>
