---
import { createTOC } from "$lib/utils";
import { BlogPost, Body, Date, Img, TableOfContent } from "$lib/components";
import { getCollection, getEntry } from "astro:content";

const { slug } = Astro.params;
if (typeof slug == "undefined") return Astro.redirect("/blog");

const post = await getEntry("blog", slug);
if (typeof post == "undefined") return Astro.redirect("/404");

const { Content, headings, remarkPluginFrontmatter } = await post.render();
const { minutesRead } = remarkPluginFrontmatter;
const { data } = post;

const relatedPosts = await getCollection(
  "blog",
  (blog) =>
    blog.data.date &&
    blog.data.category?.toLowerCase() == post.data.category?.toLowerCase() &&
    blog.id != post.id
);
---

<Body>
  <h1>{data.title}</h1>
  <p class="muted no-mb"><Date date={data.date} /> &bull; {minutesRead}</p>

  {
    data.category && (
      <p class="muted">
        Category:&nbsp;
        <a
          href={`/blog?search=${data.category}`}
          style="text-transform: capitalize;"
        >
          {data.category}
        </a>
      </p>
    )
  }

  <p class="muted no-mb">{data.description}</p>

  {
    data.image && (
      <>
        <Img
          src={data.image.src}
          width="800"
          alt="My post"
          class="hero-img no-mb"
          style="margin-top: var(--margin-bottom);"
        />
        {data.image.credit && data.image.link && (
          <figcaption class="muted no-mb">
            {data.image.credit}.{" "}
            <a href={data.image.link} target="_blank" rel="noopener noreferrer">
              Link.
            </a>
          </figcaption>
        )}
      </>
    )
  }

  <div class="divider breakout"></div>

  <details>
    <summary aria-haspopup="listbox">Table of contents</summary>
    <div class="toc no-mb">
      <TableOfContent headings={createTOC(headings)} />
    </div>
  </details>

  <section class="md full-width">
    <Content />
  </section>

  <div class="divider breakout"></div>

  {
    relatedPosts.length > 0 && (
      <section>
        <p>
          <strong>Also read</strong>
        </p>
        <BlogPost blogs={relatedPosts} />
      </section>
    )
  }
</Body>

<style>
  h1 {
    display: inline-block;
    background-image: linear-gradient(
      to right,
      var(--on-bg-color, var(--color-on-background)),
      var(--on-bg-color-alt, var(--color-on-background)) 70%
    );
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  details {
    margin-bottom: var(--space-s);
    border: 1.5px solid var(--color-tertiary);
    border-radius: var(--border-radius);
    cursor: pointer;

    /* width: min-content;
    background-color: var(--color-background);
    position: sticky;
    top: var(--space-s);
    z-index: 1;
    isolation: isolate; */
  }

  /* details[open],
  details[open] > summary {
    width: auto;
  } */

  summary {
    /* width: max-content; */
    padding: var(--space-s);
    color: var(--color-tertiary);
  }

  .toc {
    max-height: 60vh;
    overflow-y: scroll;
  }

  .toc > :global(ul) {
    list-style: none;
  }

  .toc :global(li) {
    margin-inline: var(--space-s);
  }

  figcaption {
    margin-top: var(--space-s);
    font-size: var(--step--1);
    text-align: center;
  }

  .prose :global(pre) {
    grid-column: breakout;
  }

  .divider {
    margin-block: var(--space-m);
  }
</style>
